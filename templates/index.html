<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Collaborative IDE</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      body {
        background-color: #1e1e1e;
        color: #d4d4d4;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      #top-bar {
        background-color: #333;
        padding: 10px;
        border-bottom: 1px solid #444;
        color: #d4d4d4;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      #bottom-bar {
        background-color: #333;
        border-top: 1px solid #444;
        padding: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        color: #d4d4d4;
      }

      #bottom-bar label {
        margin-right: 10px;
        white-space: nowrap;
      }

      #language-select {
        width: 10%;
        min-width: 50px;
        margin-right: 20px;
      }
      #content-area {
        display: flex;
        flex: 1;
        overflow: hidden;
      }
      #sidebar {
        width: 250px;
        background-color: #252526;
        border-right: 1px solid #333;
        padding: 10px;
        overflow-y: auto;
      }
      #main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        overflow: hidden;
        background-color: #1e1e1e;
        color: #d4d4d4;
      }
      #current-file {
        font-weight: bold;
        margin-bottom: 10px;
        font-size: 1.2em;
        color: #9cdcfe;
      }
      #editor {
        flex: 1;
        border: 1px solid #333;
      }
      #right-panel {
        width: 300px;
        background-color: #252526;
        border-left: 1px solid #333;
        padding: 10px;
        overflow-y: auto;
      }
      .folder-icon::before {
        content: "\f07b";
        font-family: "Font Awesome 6 Free";
        margin-right: 8px;
        color: #9cdcfe;
      }
      .file-icon::before {
        content: "\f15b";
        font-family: "Font Awesome 6 Free";
        margin-right: 8px;
        color: #d4d4d4;
      }
      .list-group-item {
        background-color: #252526;
        border: none;
        color: #d4d4d4;
      }
      .list-group-item:hover {
        background-color: #373737;
      }
      .btn-success-indication {
        background-color: #28a745 !important;
        border-color: #28a745 !important;
      }
      .btn-success-indication:hover {
        background-color: #218838 !important;
        border-color: #1e7e34 !important;
      }

      .btn-success {
        background-color: #007acc;
        border-color: #007acc;
      }
      .btn-success:hover {
        background-color: #006bb3;
        border-color: #006bb3;
      }
      .btn-primary {
        background-color: #007acc;
        border-color: #007acc;
      }
      .btn-primary:hover {
        background-color: #006bb3;
        border-color: #006bb3;
      }
      .selected_folder{
        background-color: #28a745;
      }
    </style>
  </head>
  <body>
    <div id="top-bar">
      <div class="ms-3">
        <i class="fab fa-windows"></i> <strong>Collaborative IDE</strong>
      </div>
      <div class="me-3">
        Room: <span id="room-id"></span> | User: <span id="username"></span>
      </div>
      <button class="btn btn-success w-10" onclick="logout(event)">Log out</button>
    </div>
    <div id="content-area">
      <div id="sidebar">
        <h5>EXPLORER</h5>
        <div id="file-tree" class="list-group"></div>
        <button class="btn btn-success mt-3 w-100" onclick="createNewFolder()">
          <i class="fas fa-folder-plus"></i> New Folder
        </button>
        <button class="btn btn-success mt-3 w-100" onclick="createNewFile()">
          <i class="fas fa-file-code"></i> New File
        </button>
        <button class="btn btn-success mt-3 w-100" onclick="goback(event)">Reset Path</button>
      </div>
      <div id="main-content">
        <div id="current-file">No file selected</div>
        <div id="editor">Select a file to start editing...</div>
        <button class="btn btn-primary mt-3" onclick="saveFile()" id="save">Save</button>
      </div>
      <div id="right-panel">
        <h5>Contributors</h5>
        <div class="list-group", id="grp">
        </div>
      </div>
    </div>
    <div id="bottom-bar">
      <label for="language-select">Language:</label>
      <select id="language-select" class="form-select" aria-label="Language select">
        <option value="python" selected>Python</option>
        <option value="java">Java</option>
        <option value="javascript">JavaScript</option>
        <option value="html">HTML</option>
        <option value="c_cpp">C++</option>
        <option value="c">C</option>
        <option value="csharp">C#</option>
        <option value="go">Go</option>
        <option value="lua">Lua</option>
      </select>
      <div>
        <a href="https://www.github.com/sowoul" style="color:greenyellow">By Ojaswa Sharma</a>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ext-language_tools.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>

    <script>


      const editor = ace.edit("editor");
      ace.require("ace/ext/language_tools");
      editor.setOptions({
        enableBasicAutocompletion: true,
        enableLiveAutocompletion: true,
      });
    
      editor.setTheme("ace/theme/monokai");
      editor.session.setMode("ace/mode/python");
    
      document.getElementById("language-select").addEventListener("change", function () {
        const selectedLanguage = this.value;
        switch (selectedLanguage) {
          case "python":
            editor.session.setMode("ace/mode/python");
            break;
          case "java":
            editor.session.setMode("ace/mode/java");
            break;
          case "javascript":
            editor.session.setMode("ace/mode/javascript");
            break;
          case "html":
            editor.session.setMode("ace/mode/html");
            break;
          case "c_cpp":
            editor.session.setMode("ace/mode/c_cpp");
            break;
          case "c":
            editor.session.setMode("ace/mode/c_cpp");
            break;
          case "csharp":
            editor.session.setMode("ace/mode/csharp");
            break;
          case "go":
            editor.session.setMode("ace/mode/go");
            break;
          case "lua":
            editor.session.setMode("ace/mode/lua");
            break;
          default:
            editor.session.setMode("ace/mode/text");
            break;

        }
      });
    
      const socket = io.connect();
      let currentFolder = "";
      let currentFile = "";
      let lastClicked = ""; 
    
      fetch("/getinfo")
        .then((response) => response.json())
        .then((data) => {
          document.getElementById("room-id").textContent = data.room;
          document.getElementById("username").textContent = data.username;
    
          fetch(`/get_file_tree?room=${data.room}`)
            .then((response) => response.json())
            .then((treeData) => buildFileTree(treeData))
            .catch((err) => console.error("Error fetching file tree:", err));
        });
    
      function logout(event) {
        event.preventDefault();
        window.location = "/login";
      }
      function goback(event){
        event.preventDefault();
        currentFolder = "";
        currentFile = "";
        lastClicked = ""; 
      }
      function buildFileTree(treeData) {
        const tree = document.getElementById("file-tree");
        tree.innerHTML = "";
    
        treeData.forEach((folder) => {
          const folderItem = document.createElement("div");
          folderItem.classList.add("list-group-item", "folder-icon");
          folderItem.textContent = folder.name;
          folderItem.onclick = () => {
            toggleFolder(folderItem);
            lastClicked = folder.name; 
          };
    
          const subTree = document.createElement("div");
          subTree.style.display = "none";
          folderItem.appendChild(subTree);
    
          folder.subfolders.forEach((subfolder) => {
            const subfolderItem = document.createElement("div");
            subfolderItem.classList.add("list-group-item", "folder-icon", "ms-3");
            subfolderItem.textContent = subfolder.name;
            subfolderItem.onclick = () => {
              toggleFolder(subfolderItem);
              lastClicked = subfolder.name;
            };
    
            const fileSubTree = document.createElement("div");
            fileSubTree.style.display = "none";
            subfolderItem.appendChild(fileSubTree);
    
            subfolder.files.forEach((file) => {
              const fileItem = document.createElement("div");
              fileItem.classList.add("list-group-item", "file-icon", "ms-5");
              fileItem.textContent = file.name;
              fileItem.onclick = () => loadFile(folder.name, subfolder.name, file.name);
              fileSubTree.appendChild(fileItem);
            });
    
            subTree.appendChild(subfolderItem);
          });
    
          folder.files.forEach((file) => {
            const fileItem = document.createElement("div");
            fileItem.classList.add("list-group-item", "file-icon", "ms-3");
            fileItem.textContent = file.name;
            fileItem.onclick = () => loadFile(folder.name, "", file.name);
            subTree.appendChild(fileItem);
          });
    
          tree.appendChild(folderItem);
        });
      }
    
      function toggleFolder(folderItem) {
        const subTree = folderItem.querySelector("div");
        subTree.style.display = subTree.style.display === "none" ? "block" : "none";
      }
    
      function loadFile(folderName, subfolderName, fileName) {
        currentFolder = folderName;
        currentFile = fileName;
        document.getElementById("current-file").textContent = `${folderName}/${subfolderName}/${fileName}`;
        socket.emit("load_file", {
          folder_name: folderName,
          subfolder_name: subfolderName,
          file_name: fileName,
        });
      }
    
      socket.on("file_loaded", (data) => {
        editor.setValue(data.content);
      });
    
      function saveFile() {
        const content = editor.getValue();
        socket.emit("file_update", {
          folder_name: currentFolder,
          file_name: currentFile,
          content,
        });
    
        const saveButton = document.getElementById("save");
        saveButton.classList.add("btn-success-indication");
        saveButton.textContent = "Saved!!";
        setTimeout(() => {
          saveButton.classList.remove("btn-success-indication");
          saveButton.textContent = "Save";
        }, 2000);
      }
    
      function createNewFolder() {
        const folderName = prompt("Enter new folder name:");
        if (folderName) {
          socket.emit("create_folder", { folder_name: folderName, parent_folder_id :lastClicked || currentFolder });
        }
      }
    
      function createNewFile() {
        const fileName = prompt("Enter new file name:");
        if (fileName) {
          socket.emit("create_file", {
            file_name: fileName,
            folder_name: lastClicked || currentFolder,
          });
        }
      }
    
      socket.on("folder_created", () => {
        fetch(`/get_file_tree?room=${document.getElementById("room-id").textContent}`)
          .then((response) => response.json())
          .then((treeData) => buildFileTree(treeData))
          .catch((err) => console.error("Error updating file tree after folder creation:", err));
      });
    
      socket.on("file_created", () => {
        fetch(`/get_file_tree?room=${document.getElementById("room-id").textContent}`)
          .then((response) => response.json())
          .then((treeData) => buildFileTree(treeData))
          .catch((err) => console.error("Error updating file tree after file creation:", err));
      });
    
      socket.on('newjoin', (data) => {
        const field = document.getElementById("grp");
        var temp = "";
        data.forEach(function (val) {
          temp += `<a class="list-group-item list-group-item-action">` + val + `</a>`;
        });
        field.innerHTML = temp;
      });
    </script>
      </body>
</html>
